{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mandala_sadhana.css') }}">

<style>
/* ===== BASIC FALLBACK STYLES ===== */
.sadhana-hero-modern {
    background: linear-gradient(to right, #c41e3a 0%, #ea580c 100%) !important;
    padding: 1.5rem 0 !important;
    min-height: 120px !important;
}

.hero-title-modern {
    font-size: 2.5rem;
    color: white !important;
    text-align: center;
    margin-bottom: 0.5rem;
}

.form-card-modern {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(196, 30, 58, 0.1);
    border: 1px solid var(--border-color);
}

.btn-primary-modern {
    background: var(--primary-red);
    color: white;
    padding: 1rem 3rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
}

.commitment-section-modern.error {
    border: 2px solid #c41e3a;
    border-radius: 15px;
    padding: 1rem;
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Modern Hero Section -->
<section class="sadhana-hero-modern">
    <div class="hero-container-modern">
        <div class="hero-content-modern">
            <!-- Enhanced Badge with Animation -->
            <div class="hero-badge-modern">
                <div class="badge-container">
                    <span class="badge-pulse-modern">
                        <span>Sacred Journey</span>
                    </span>
                    <div class="badge-glow"></div>
                </div>
            </div>

            <!-- Enhanced Title with Gradient -->
            <h1 class="hero-title-modern">
                <span class="title-gradient">Mandala Sadhana</span>
                <div class="title-underline"></div>
            </h1>

            <!-- Enhanced Subtitle -->
            <p class="hero-subtitle-modern">Your Path to Divine Transformation</p>

            <!-- Enhanced Description -->
            
        </div>

        <!-- Enhanced Visual with Improved Animation -->
        <div class="hero-visual-modern">
            <div class="mandala-container-modern">
                <div class="mandala-rings-modern">
                    <div class="ring-modern ring-1-modern"></div>
                    <div class="ring-modern ring-2-modern"></div>
                    <div class="ring-modern ring-3-modern"></div>
                    <div class="ring-modern ring-4-modern"></div>
                    <div class="mandala-core-modern">
                        <div class="core-glow"></div>
                    </div>
                </div>
                <div class="energy-waves-modern">
                    <div class="wave-modern wave-1-modern"></div>
                    <div class="wave-modern wave-2-modern"></div>
                    <div class="wave-modern wave-3-modern"></div>
                    <div class="wave-modern wave-4-modern"></div>
                </div>
                <div class="sacred-particles">
                    <div class="particle particle-1">॰</div>
                    <div class="particle particle-2">॰</div>
                    <div class="particle particle-3">॰</div>
                    <div class="particle particle-4">॰</div>
                    <div class="particle particle-5">॰</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll Indicator -->
    <div class="scroll-indicator">
        <div class="scroll-mouse">
            <div class="scroll-wheel"></div>
        </div>
        <span class="scroll-text">Begin Your Journey</span>
    </div>
</section>

<!-- Modern Main Content -->
<section class="sadhana-content-modern">
    <div class="container">
        <!-- Enhanced Registration Form -->
        <div class="form-section-modern">
            <form method="POST" id="mandalaForm" class="registration-form-modern" novalidate>
                {{ form.hidden_tag() }}

                <!-- Single Consolidated Form Card -->
                <div class="form-card-modern">
                    <div class="card-header-modern">
                        <div class="card-title-modern">
                            <h3>Mandala Sadhana Registration</h3>
                            <p>Complete your sacred journey details</p>
                        </div>
                    </div>

                    <div class="form-content-modern">
                        <!-- All form fields in single section -->
                        <div class="form-grid-modern">
                            <div class="form-group-modern">
                                <div class="input-wrapper-modern">
                                    <label for="{{ form.email.id }}" class="form-label-modern">
                                        Email
                                    </label>
                                    <div class="input-container-modern">
                                        {{ form.email(class="form-input-modern", placeholder="Enter your email", autocomplete="email", value=current_user.email, **{"required": True}) }}
                                    </div>
                                    {% if form.email.errors %}
                                        <div class="form-errors-modern">
                                            {% for error in form.email.errors %}
                                                <span class="error-text-modern">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                     <div class="form-help-modern"></div>
                                </div>
                            </div>

                            <div class="form-group-modern">
                                <div class="input-wrapper-modern">
                                    <label for="{{ form.full_name.id }}" class="form-label-modern">
                                        Full Name & Geo Location
                                    </label>
                                    <div class="input-container-modern">
                                        {{ form.full_name(class="form-input-modern", placeholder="Enter your full name and location", autocomplete="name", value=current_user.full_name or "", **{"required": True}) }}
                                    </div>
                                    {% if form.full_name.errors %}
                                        <div class="form-errors-modern">
                                            {% for error in form.full_name.errors %}
                                                <span class="error-text-modern">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-help-modern"></div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- 48-Day Mandala Commitment -->
                        <div class="commitment-section-modern">
                            <div class="commitment-header-modern">
                                <div class="commitment-info-modern">
                                    <h4 class="commitment-title-modern">Single Mandala (48 Days)</h4>
                                </div>
                            </div>
                            <div class="commitment-content-modern">
                                <p class="commitment-question-modern">Are you ready to commit to a 48-day (1) Mandala, honoring each day as a step into deeper presence with Bhairava?</p>
                                <div class="choice-grid-modern">
                                    <label class="choice-card-modern" for="mandala48_yes">
                                        <input type="radio" id="mandala48_yes" name="mandala_48_commitment" value="Yes" {{ 'checked' if form.mandala_48_commitment.data and form.mandala_48_commitment.data == 'Yes' else '' }}>
                                        <div class="choice-content-modern">
                                            <div class="choice-text-modern">
                                                <h5>Yes, I am ready</h5>
                                                <p>I commit to this sacred 48-day journey with full devotion and awareness</p>
                                            </div>
                                        </div>
                                    </label>

                                    <label class="choice-card-modern" for="mandala48_no">
                                        <input type="radio" id="mandala48_no" name="mandala_48_commitment" value="No" {{ 'checked' if form.mandala_48_commitment.data and form.mandala_48_commitment.data == 'No' else '' }}>
                                        <div class="choice-content-modern">
                                            <div class="choice-text-modern">
                                                <h5>No, not yet</h5>
                                                <p>I need more time to prepare for this sacred commitment</p>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                {% if form.mandala_48_commitment.errors %}
                                    <div class="form-errors-modern">
                                        {% for error in form.mandala_48_commitment.errors %}
                                            <span class="error-text-modern">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 144-Day Triad Commitment -->
                        <div class="commitment-section-modern">
                            <div class="commitment-header-modern">
                                <div class="commitment-info-modern">
                                    <h4 class="commitment-title-modern">Triple Mandala (144 Days)</h4>
                                    <p class="commitment-subtitle-modern">Three foundational mandalas</p>
                                </div>
                            </div>
                            <div class="commitment-content-modern">
                                <p class="commitment-question-modern">Do you feel called to walk the full triad of 144-Days (3) Mandalas — building a sacred foundation for transformation and inner stability?</p>
                                <div class="choice-grid-modern">
                                    <label class="choice-card-modern" for="mandala144_yes">
                                        <input type="radio" id="mandala144_yes" name="mandala_144_commitment" value="Yes" {{ 'checked' if form.mandala_144_commitment.data and form.mandala_144_commitment.data == 'Yes' else '' }}>
                                    <div class="choice-content-modern">
                                        <div class="choice-text-modern">
                                            <h5>Yes, I feel the call</h5>
                                            <p>I am drawn to the deeper path of three mandalas for profound transformation</p>
                                        </div>
                                    </div>
                                </label>

                                <label class="choice-card-modern" for="mandala144_no">
                                    <input type="radio" id="mandala144_no" name="mandala_144_commitment" value="No" {{ 'checked' if form.mandala_144_commitment.data and form.mandala_144_commitment.data == 'No' else '' }}>
                                    <div class="choice-content-modern">
                                        <div class="choice-text-modern">
                                            <h5>No, one mandala is enough</h5>
                                            <p>I choose to focus on a single mandala for now</p>
                                        </div>
                                    </div>
                                </label>

                                <label class="choice-card-modern" for="mandala144_notready">
                                    <input type="radio" id="mandala144_notready" name="mandala_144_commitment" value="Not Yet Ready" {{ 'checked' if form.mandala_144_commitment.data and form.mandala_144_commitment.data == 'Not Yet Ready' else '' }}>
                                    <div class="choice-content-modern">
                                        <div class="choice-text-modern">
                                            <h5>Not yet ready</h5>
                                            <p>I need more time to prepare for this deeper commitment</p>
                                        </div>
                                    </div>
                                    </label>
                                </div>
                                {% if form.mandala_144_commitment.errors %}
                                    <div class="form-errors-modern">
                                        {% for error in form.mandala_144_commitment.errors %}
                                            <span class="error-text-modern">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    
                        <!-- Sacred Vow -->
                        <div class="form-group-modern">
                            <div class="input-wrapper-modern">
                                <label for="{{ form.commitment_text.id }}" class="form-label-modern">
                                    Can you hold your Sadhana with sincerity and steadiness, even when the mind resists or the path feels silent?
                                </label>
                                <div class="textarea-container-modern">
                                    {{ form.commitment_text(class="form-input-modern form-textarea-modern", rows="6", placeholder="Please share your inner commitment and understanding of this sacred practice...", **{"required": True}) }}
                                </div>
                                <div class="character-counter-modern">
                                    <span class="current-count">0</span> / <span class="max-count">500</span> characters
                                </div>
                                {% if form.commitment_text.errors %}
                                    <div class="form-errors-modern">
                                        {% for error in form.commitment_text.errors %}
                                            <span class="error-text-modern">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-help-modern"></div>
                            </div>
                        
                        <!-- Sadhana Details -->
                        <div class="form-grid-modern">
                            <div class="form-group-modern">
                                <div class="input-wrapper-modern">
                                    <label for="{{ form.sadhana_start_date.id }}" class="form-label-modern">
                                        When did your Sadhana begin?
                                    </label>
                                    <div class="input-container-modern">
                                        {{ form.sadhana_start_date(class="form-input-modern", **{"required": True}) }}
                                    </div>
                                    {% if form.sadhana_start_date.errors %}
                                        <div class="form-errors-modern">
                                            {% for error in form.sadhana_start_date.errors %}
                                                <span class="error-text-modern">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-help-modern">
                                        <small>When did your Sadhana begin? (Mark the day of inner commitment)</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group-modern">
                                <div class="input-wrapper-modern">
                                    <label for="{{ form.sadhana_type.id }}" class="form-label-modern">
                                        Which Sadhana are you committing to as part of your Mandala journey?
                                    </label>
                                    <div class="input-container-modern">
                                        {{ form.sadhana_type(class="form-input-modern", **{"required": True}) }}
                                    </div>
                                    {% if form.sadhana_type.errors %}
                                        <div class="form-errors-modern">
                                            {% for error in form.sadhana_type.errors %}
                                                <span class="error-text-modern">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-help-modern">

                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Email Copy Checkbox -->
                        <div class="form-group-modern">
                            <div class="checkbox-container-modern">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="submit-section-modern" style="display: flex; justify-content: flex-end;">
                            <div class="submit-container">
                                <button type="submit" class="btn-modern btn-primary-modern" id="submitBtn">
                                    <div class="btn-content">
                                        <div class="btn-icon">
                                            <i class="fas fa-rocket"></i>
                                        </div>
                                        <span class="btn-text-modern">Begin Sacred Journey</span>
                                        <div class="btn-arrow">
                                            <i class="fas fa-arrow-right"></i>
                                        </div>
                                    </div>
                                    <span class="btn-loading-modern" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Submitting...</span>
                                    </span>
                                    <div class="btn-shine"></div>
                                    <div class="btn-glow"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Modern Footer -->
            <div class="form-footer-modern">
                <div class="footer-content-modern">
                    

                    <div class="blessing-card-modern">
                        <div class="blessing-content-modern">
                            <h4 class="blessing-title-modern">Jai Bhairava!</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced form validation and UX for modern design
    const form = document.getElementById('mandalaForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text-modern');
    const btnLoading = submitBtn.querySelector('.btn-loading-modern');

    // Real-time validation
    const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
    inputs.forEach(input => {
        input.addEventListener('blur', validateField);
        input.addEventListener('input', clearFieldError);
    });

    // Initialize modern choice cards
    initializeChoiceCards();

    // Initialize character counter
    initializeCharacterCounter();

    // Initialize floating labels
    initializeFloatingLabels();

    function validateField(e) {
        const field = e.target;
        const wrapper = field.closest('.input-wrapper-modern');
        const errorDiv = wrapper.querySelector('.error-messages-modern');

        // Clear previous errors
        if (errorDiv) {
            errorDiv.innerHTML = '';
        }

        // Validate field
        if (!field.value.trim()) {
            showFieldError(wrapper, 'This field is required');
            return false;
        }

        if (field.name === 'email' && !isValidEmail(field.value)) {
            showFieldError(wrapper, 'Please enter a valid email address');
            return false;
        }

        if (field.name === 'commitment_text' && field.value.length < 20) {
            showFieldError(wrapper, 'Please provide at least 20 characters explaining your commitment');
            return false;
        }

        // Clear error styling
        wrapper.classList.remove('error');
        return true;
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function clearFieldError(e) {
        const wrapper = e.target.closest('.input-wrapper-modern');
        wrapper.classList.remove('error');
        const errorDiv = wrapper.querySelector('.error-messages-modern');
        if (errorDiv) {
            errorDiv.innerHTML = '';
        }
    }

    function showFieldError(wrapper, message) {
        wrapper.classList.add('error');
        let errorDiv = wrapper.querySelector('.error-messages-modern');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'error-messages-modern';
            wrapper.appendChild(errorDiv);
        }
        errorDiv.innerHTML = `<span class="error-text-modern">${message}</span>`;
    }

    // Function to validate radio button groups
    function validateRadioGroups() {
        const radioGroups = ['mandala_48_commitment', 'mandala_144_commitment'];
        let isValid = true;

        radioGroups.forEach(groupName => {
            const radios = form.querySelectorAll(`input[name="${groupName}"]`);
            const checked = Array.from(radios).some(radio => radio.checked);
            
            if (!checked) {
                // Find the commitment section and highlight it
                const firstRadio = radios[0];
                const commitmentSection = firstRadio.closest('.commitment-section-modern');
                if (commitmentSection) {
                    commitmentSection.classList.add('error');
                    const questionElement = commitmentSection.querySelector('.commitment-question-modern');
                    if (questionElement) {
                        questionElement.style.color = '#c41e3a';
                    }
                }
                isValid = false;
            } else {
                // Remove error styling if checked
                const firstRadio = radios[0];
                const commitmentSection = firstRadio.closest('.commitment-section-modern');
                if (commitmentSection) {
                    commitmentSection.classList.remove('error');
                    const questionElement = commitmentSection.querySelector('.commitment-question-modern');
                    if (questionElement) {
                        questionElement.style.color = '';
                    }
                }
            }
        });

        return isValid;
    }

    // Form submission with loading state
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate all fields
        let isValid = true;
        inputs.forEach(input => {
            if (!validateField({ target: input })) {
                isValid = false;
            }
        });

        // Validate radio button groups
        if (!validateRadioGroups()) {
            isValid = false;
        }

        if (!isValid) {
            // Scroll to first error or radio section
            const firstCommitmentError = form.querySelector('.commitment-section-modern.error');
            if (firstCommitmentError) {
                firstCommitmentError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            // Focus first error field
            const firstError = form.querySelector('.input-wrapper-modern.error');
            if (firstError) {
                const input = firstError.querySelector('input, textarea, select');
                if (input) {
                    input.focus();
                }
            }
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-flex';

        // Submit form
        form.submit();
    });

    // Auto-focus first input
    const firstInput = form.querySelector('input[required]');
    if (firstInput) {
        firstInput.focus();
    }

    // Modern Choice Cards Functions
    function initializeChoiceCards() {
        const choiceCards = document.querySelectorAll('.choice-card-modern');

        choiceCards.forEach(card => {
            card.addEventListener('click', function() {
                const radioInput = this.querySelector('input[type="radio"]');
                const groupName = radioInput.name;

                // Remove selected class from all cards in the same group
                const sameGroupCards = document.querySelectorAll(`input[name="${groupName}"]`);
                sameGroupCards.forEach(input => {
                    input.closest('.choice-card-modern').classList.remove('selected');
                });

                // Add selected class to clicked card
                this.classList.add('selected');

                // Check the corresponding radio input
                radioInput.checked = true;

                // Trigger change event for form validation
                radioInput.dispatchEvent(new Event('change', { bubbles: true }));

                // Clear error styling when radio is selected
                const commitmentSection = radioInput.closest('.commitment-section-modern');
                if (commitmentSection) {
                    commitmentSection.classList.remove('error');
                    const questionElement = commitmentSection.querySelector('.commitment-question-modern');
                    if (questionElement) {
                        questionElement.style.color = '';
                    }
                }

                // Add visual feedback
                this.style.transform = 'translateY(-8px) scale(1.02)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 300);
            });

            // Add hover effects
            card.addEventListener('mouseenter', function() {
                if (!this.classList.contains('selected')) {
                    this.style.transform = 'translateY(-4px)';
                }
            });

            card.addEventListener('mouseleave', function() {
                if (!this.classList.contains('selected')) {
                    this.style.transform = '';
                }
            });
        });

        // Initialize selected states based on existing values
        const checkedRadios = document.querySelectorAll('input[type="radio"]:checked');
        checkedRadios.forEach(radio => {
            radio.closest('.choice-card-modern').classList.add('selected');
        });
    }

    // Character Counter Function
    function initializeCharacterCounter() {
        const commitmentTextarea = document.querySelector('textarea[name="commitment_text"]');
        const currentCount = document.querySelector('.current-count');
        const maxCount = document.querySelector('.max-count');

        if (commitmentTextarea && currentCount && maxCount) {
            commitmentTextarea.addEventListener('input', function() {
                const count = this.value.length;
                currentCount.textContent = count;

                // Update color based on character count
                if (count > 450) {
                    currentCount.style.color = '#dc2626';
                } else if (count > 350) {
                    currentCount.style.color = '#f59e0b';
                } else {
                    currentCount.style.color = 'var(--primary-red)';
                }
            });
        }
    }

    // Floating Labels Function
    function initializeFloatingLabels() {
        const inputs = document.querySelectorAll('.form-input-modern');

        inputs.forEach(input => {
            const wrapper = input.closest('.input-wrapper-modern');
            const label = wrapper.querySelector('.form-label-modern');

            // Check if input has value on load
            if (input.value.trim() !== '') {
                label.classList.add('float');
            }

            input.addEventListener('focus', function() {
                label.classList.add('float');
            });

            input.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    label.classList.remove('float');
                }
            });
        });
    }
});
</script>
{% endblock %}

