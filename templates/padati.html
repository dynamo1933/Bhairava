{% extends "base.html" %}

{% block content %}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<!-- Hero Section -->
<section class="padati-hero">
    <div class="hero-background">
        <div class="hero-content">
            <div class="hero-text">
                <div class="om-symbol-large">ğŸ•‰ï¸</div>
                <h1 class="hero-title">Spiritual Progress</h1>
                <p class="hero-subtitle">Your journey through the sacred stages of spiritual development</p>
            </div>
            
        </div>
        
    </div>
</section>

<!-- Main Content Container -->
<div class="padati-main">
    <div class="container">
        <!-- Progress Overview -->

        <!-- Progress Section -->
        <div class="progress-section">
            <!-- Horizontal Progress Bar -->
            <div class="progress-container">
                <div class="progress-track-modern">
                    {% for stage_num in range(1, 7) %}
                        {% set stage_info = current_user.get_stage_info(stage_num) %}
                        {% set is_current = stage_num == current_user.get_current_stage() %}
                        {% set is_completed = stage_num < current_user.get_current_stage() and stage_info.has_access %}
                        {% set is_accessible = stage_info.has_access %}
                        {% set next_required_stage = current_user.get_next_required_stage() %}
                        {% set is_next_stage = stage_num == next_required_stage %}

                        <div class="progress-step-modern {% if is_completed %}completed{% elif is_current %}current{% elif is_accessible %}accessible{% else %}locked{% endif %}">
                            <div class="step-visual">
                                <div class="step-circle {% if is_completed %}completed{% elif is_current %}current{% elif is_accessible %}accessible{% else %}locked{% endif %}">
                                    {% if stage_num == 1 %}ğŸ•‰ï¸{% elif stage_num == 2 %}ğŸŒŸ{% elif stage_num == 3 %}âœ¨{% elif stage_num == 4 %}ğŸ“¿{% elif stage_num == 5 %}ğŸ”®{% else %}ğŸ’{% endif %}
                                </div>
                                {% if is_completed %}
                                    <div class="completion-badge">âœ“</div>
                                {% endif %}
                            </div>
                            <div class="step-content">
                                <div class="step-title">{{ stage_info.stage_name }}</div>
                                {% if is_completed %}
                                    <div class="step-status completed">Completed</div>
                                {% elif stage_info.completion_date %}
                                    <div class="step-date">Completed {{ stage_info.completion_date.strftime('%b %d, %Y') }}</div>
                                {% elif stage_info.start_date and is_current %}
                                    <div class="step-date">Started {{ stage_info.start_date.strftime('%b %d, %Y') }}</div>
                                {% elif is_current %}
                                    <div class="step-status current">Current Stage</div>
                                {% elif is_accessible %}
                                    <div class="step-status accessible">Access Granted</div>
                                {% else %}
                                    <div class="step-status locked">ğŸ”’ Locked</div>
                                {% endif %}
                                {% if stage_info.duration_days > 0 %}
                                    <div class="step-duration">{{ stage_info.duration_days }} days</div>
                                {% endif %}
                                {% if not is_accessible and not is_completed and is_next_stage %}
                                    <button class="btn-request-access" data-stage="{{ stage_num }}" onclick="requestStageAccess({{ stage_num }})">
                                        Request Access
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                        {% if stage_num < 6 %}
                            <div class="transition-arrow {% if is_completed or (is_current and stage_num < current_user.get_current_stage()) %}completed{% else %}locked{% endif %}">
                                {% if is_completed %}
                                    âœ“
                                {% else %}
                                    â¤
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="sacred-reminder">
                <div class="reminder-icon">ğŸ™</div>
                <div class="reminder-content">
                    <p class="reminder-text">
                        <em>"Each stage unfolds in divine timing. Trust the process, surrender to the journey."</em>
                    </p>
                    <div class="reminder-attribution">â€” Guru Bhairava</div>
                </div>
            </div>
        </div>
        </section>

       
        <!-- No Access State -->
        {% if not current_user.has_mandala_access(1) and not current_user.has_mandala_access(2) and not current_user.has_mandala_access(3) and not current_user.has_mandala_access(4) and not current_user.has_mandala_access(5) and not current_user.has_mandala_access(6) %}
        <section class="welcome-section">
            <div class="welcome-card">
                
                <h3 class="welcome-title"><span class="om-symbol">ğŸ•‰ï¸</span> Welcome to Your Spiritual Journey</h3>
                <p>Your sacred path begins here. Contact an administrator to receive access to the foundational teachings and begin your spiritual practice.</p>
                <div class="welcome-actions">
                    <div class="action-item">
                        <div class="action-icon">ğŸ“§</div>
                        <div class="action-content">
                            <h4>Contact Admin</h4>
                            <p>Request access to start your journey</p>
                        </div>
                    </div>
                    <div class="action-item">
                        <div class="action-icon">ğŸ“š</div>
                        <div class="action-content">
                            <h4>Study Guidelines</h4>
                            <p>Learn about the spiritual practices</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced interactions for the redesigned status section
    enhanceStatusSection();

    // Progress bar animations
    animateProgressBar();

    function enhanceStatusSection() {
        // Add hover effects to metric cards
        const metricCards = document.querySelectorAll('.metric-card');
        metricCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px) scale(1.02)';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // Add click interaction for journey metrics
        const nextStageCard = document.querySelector('.next-stage-card');
        if (nextStageCard) {
            nextStageCard.addEventListener('click', function() {
                const nextStageTitle = this.querySelector('.next-stage-body h4');
                if (nextStageTitle) {
                    showNotification(`Exploring ${nextStageTitle.textContent}`, 'info');
                }
            });
        }

        // Animate timeline items
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach((item, index) => {
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, 300 + (index * 100));
        });

        // Add completion celebration animation
        const completionStatus = document.querySelector('.completion-status-enhanced');
        if (completionStatus) {
            const celebrationIcon = completionStatus.querySelector('.completion-icon-large');
            if (celebrationIcon) {
                celebrationIcon.style.animation = 'celebrate 2s ease-in-out infinite';
            }
        }
    }

    function animateProgressBar() {
        const progressSteps = document.querySelectorAll('.progress-step-modern');
        let delay = 0;

        progressSteps.forEach(step => {
            setTimeout(() => {
                step.style.opacity = '1';
                step.style.transform = 'translateY(0)';
            }, delay);
            delay += 200;
        });
    }

    // Enhanced interactions for the redesigned status section
    enhanceRedesignedStatusSection();
});

function enhanceRedesignedStatusSection() {
    // Add hover effects to new stat cards
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.02)';
        });

        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });

    // Add click interactions for new buttons
    const nextStagePreview = document.querySelector('.next-stage-preview');
    if (nextStagePreview) {
        nextStagePreview.addEventListener('click', function() {
            const nextStageTitle = this.querySelector('.preview-info h5');
            if (nextStageTitle) {
                showNotification(`Exploring ${nextStageTitle.textContent}`, 'info');
            }
        });
    }

    // Animate timeline markers in the compact timeline
    const timelineMarkers = document.querySelectorAll('.timeline-marker');
    timelineMarkers.forEach((marker, index) => {
        setTimeout(() => {
            marker.style.opacity = '1';
            marker.style.transform = 'translateX(-50%) scale(1)';
        }, 500 + (index * 100));
    });

    // Add celebration animation for completion
    const completionCelebration = document.querySelector('.completion-celebration');
    if (completionCelebration) {
        const celebrationIcon = completionCelebration.querySelector('.celebration-icon');
        if (celebrationIcon) {
            celebrationIcon.style.animation = 'celebrate 3s ease-in-out infinite';
        }
    }
}

// New functions for the redesigned status section
function showStageGuidance(stageNum) {
    showNotification(`Guidance for Stage ${stageNum} will be displayed`, 'info');
    // Here you could open a modal or redirect to guidance content
}

function accessNextStage(stageNum) {
    showNotification(`Accessing Stage ${stageNum}...`, 'success');
    // Here you could redirect to the stage content or trigger access logic
}

function requestStageAccess(stageNum) {
    const btn = document.querySelector(`.btn-request-access[data-stage="${stageNum}"]`);
    if (btn.disabled) return;
    
    btn.disabled = true;
    btn.textContent = 'Requesting...';
    
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
    
    fetch('{{ url_for("auth.request_stage_access") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'stage_number': stageNum,
            'csrf_token': csrfToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || `Stage ${stageNum} access request sent to administrators`, 'success');
            btn.textContent = 'Requested';
            btn.classList.add('requested');
        } else {
            showNotification(data.message || 'Failed to submit request. Please try again.', 'error');
            btn.disabled = false;
            btn.textContent = 'Request Access';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
        btn.disabled = false;
        btn.textContent = 'Request Access';
    });
}

function exploreAdvancedPractices() {
    showNotification('Redirecting to advanced practices...', 'info');
    // Here you could redirect to advanced content
}

function shareSpiritualJourney() {
    if (navigator.share) {
        navigator.share({
            title: 'My Spiritual Journey',
            text: 'I have completed my spiritual journey through all sacred stages!',
            url: window.location.href
        });
    } else {
        // Fallback for browsers that don't support Web Share API
        showNotification('Journey completion shared successfully!', 'success');
    }
}

// Notification system
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
        </div>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 3000);
}

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});
</script>
{% endblock %}
