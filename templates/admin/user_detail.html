{% extends "base.html" %}

{% block content %}
<section class="admin-section user-detail-page">
    <div class="container">
        <div class="page-header">
            <a href="{{ url_for('auth.admin_users') }}" class="btn btn-secondary">‚Üê Back to Users</a>
            <h2 class="section-title">User Details</h2>
        </div>

        <div class="user-detail-grid">
            <!-- Left Column: User Info -->
            <div class="user-info-col">
                <div class="user-detail-card">
                    <div class="card-header">
                        <div class="user-avatar">
                            <img src="https://i.pravatar.cc/150?u={{ user.id }}" alt="User Avatar">
                        </div>
                        <div class="user-primary-info">
                            <h3 class="user-name">{{ user.full_name }}</h3>
                            <p class="user-username">@{{ user.username }}</p>
                            {% if user.spiritual_name %}
                                <p class="user-spiritual-name">({{ user.spiritual_name }})</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-content">
                        <h4>Basic Information</h4>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Email:</span> <span class="info-value">{{ user.email }}</span></div>
                            <div class="info-item"><span class="info-label">Phone:</span> <span class="info-value">{{ user.phone or 'N/A' }}</span></div>
                            <div class="info-item"><span class="info-label">Joined:</span> <span class="info-value">{{ user.created_at.strftime('%b %d, %Y') }}</span></div>
                        </div>
                        <hr>
                        <h4>Spiritual Practice</h4>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Guru:</span> <span class="info-value">{{ user.guru_name or 'N/A' }}</span></div>
                            <div class="info-item"><span class="info-label">Level:</span> <span class="info-value">{{ user.practice_level or 'N/A' }}</span></div>
                        </div>
                        <hr>
                        <h4>Purpose for Sadhana</h4>
                        <p class="purpose-text">{{ user.purpose }}</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Actions and Status -->
            <div class="user-actions-col">
                <div class="user-status-card">
                    <h4>Account Status</h4>
                    <div class="status-grid">
                        <div class="info-item"><span class="info-label">Role:</span> <span class="role-badge role-{{ user.role }}">{{ user.role|title }}</span></div>
                        <div class="info-item"><span class="info-label">Status:</span>
                            {% if user.is_admin() %}
                                <span class="status-badge status-admin">Admin</span>
                            {% elif user.is_approved %}
                                <span class="status-badge status-approved">Approved</span>
                            {% elif not user.is_active %}
                                <span class="status-badge status-suspended">Suspended</span>
                            {% else %}
                                <span class="status-badge status-pending">Pending</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="quick-actions">
                        {% if not user.is_admin() %}
                            {% if user.is_approved and user.is_active %}
                                <button class="btn btn-warning suspend-user" data-user-id="{{ user.id }}"><i class="fas fa-pause-circle"></i> Suspend User</button>
                            {% elif not user.is_approved and user.is_active %}
                                <button class="btn btn-success approve-user" data-user-id="{{ user.id }}"><i class="fas fa-check-circle"></i> Approve User</button>
                                <button class="btn btn-danger reject-user" data-user-id="{{ user.id }}"><i class="fas fa-times-circle"></i> Reject User</button>
                            {% elif not user.is_active %}
                                <button class="btn btn-success reactivate-user" data-user-id="{{ user.id }}"><i class="fas fa-play-circle"></i> Reactivate User</button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="mandala-access-card">
                    <h4>üïâÔ∏è Mandala Access</h4>
                    <form method="POST" action="{{ url_for('auth.update_mandala_access', user_id=user.id) }}" class="mandala-access-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mandala-access-grid">
                            <div class="mandala-access-item granted">
                                <div class="mandala-icon">üïâÔ∏è</div>
                                <div class="mandala-info">
                                    <strong>Mandala 1</strong>
                                    <small>Access Granted</small>
                                </div>
                                <div class="mandala-status">‚úì</div>
                            </div>
                            <div class="mandala-access-item {% if user.mandala_2_access %}granted{% else %}locked{% endif %}">
                                <div class="mandala-icon">üåü</div>
                                <div class="mandala-info">
                                    <strong>Mandala 2</strong>
                                    <small>{% if user.mandala_2_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="mandala-status">
                                    <label class="switch">
                                        <input type="checkbox" name="mandala_2_access" {% if user.mandala_2_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="mandala-access-item {% if user.mandala_3_access %}granted{% else %}locked{% endif %}">
                                <div class="mandala-icon">‚ú®</div>
                                <div class="mandala-info">
                                    <strong>Mandala 3</strong>
                                    <small>{% if user.mandala_3_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="mandala-status">
                                    <label class="switch">
                                        <input type="checkbox" name="mandala_3_access" {% if user.mandala_3_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Access</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success/Error Messages -->
<div id="message-container" class="message-container" style="display: none;">
    <div class="message-content">
        <span id="message-text"></span>
        <button class="message-close" onclick="hideMessage()">√ó</button>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Action</h3>
            <button class="modal-close" onclick="closeConfirmationModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p id="confirmation-message"></p>
        </div>
        <div class="modal-footer">
            <button id="confirm-action-btn" class="btn btn-danger">Confirm</button>
            <button class="btn btn-secondary" onclick="closeConfirmationModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle quick action buttons
    document.querySelectorAll('.approve-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'approve', 'Approved via user detail page');
        });
    });
    
    document.querySelectorAll('.reject-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            openConfirmationModal('Are you sure you want to reject this user?', function() {
                executeUserAction(userId, 'reject', 'Rejected via user detail page');
            });
        });
    });
    
    document.querySelectorAll('.suspend-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            openConfirmationModal('Are you sure you want to suspend this user?', function() {
                executeUserAction(userId, 'suspend', 'Suspended via user detail page');
            });
        });
    });
    
    document.querySelectorAll('.reactivate-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'approve', 'Reactivated via user detail page');
        });
    });
});

function executeUserAction(userId, action, notes) {
    fetch('{{ url_for("auth.approve_user") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'user_id': userId,
            'action': action,
            'notes': notes,
            'csrf_token': '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Reload page after short delay to show updated status
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const messageText = document.getElementById('message-text');
    
    messageText.textContent = message;
    container.className = `message-container message-${type}`;
    container.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => hideMessage(), 5000);
}

function hideMessage() {
    document.getElementById('message-container').style.display = 'none';
}

function openConfirmationModal(message, onConfirm) {
    const modal = document.getElementById('confirmation-modal');
    const messageElement = document.getElementById('confirmation-message');
    const confirmBtn = document.getElementById('confirm-action-btn');

    messageElement.textContent = message;
    modal.style.display = 'flex';

    confirmBtn.onclick = function() {
        onConfirm();
        closeConfirmationModal();
    };
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.style.display = 'none';
}
</script>
{% endblock %}
