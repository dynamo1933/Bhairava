{% extends "base.html" %}

{% block content %}
<section class="admin-section">
    <div class="container">
        <div class="section-header">
            <div class="header-icon">üë§</div>
            <h2 class="section-title">User Details</h2>
            <div class="header-decoration"></div>
        </div>
        
        <!-- User Detail Card -->
        <div class="user-detail-card">
            <div class="card-header">
                <h3>User Information</h3>
                <a href="{{ url_for('auth.admin_users') }}" class="btn btn-secondary">‚Üê Back to Users</a>
            </div>
            
            <div class="card-content">
                <div class="user-info-grid">
                    <div class="info-section">
                        <h4>Basic Information</h4>
                        <div class="info-row">
                            <span class="info-label">User ID:</span>
                            <span class="info-value">{{ user.id }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Username:</span>
                            <span class="info-value">{{ user.username }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Full Name:</span>
                            <span class="info-value">{{ user.full_name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">{{ user.email }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">{{ user.phone or 'Not provided' }}</span>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h4>Account Status</h4>
                        <div class="info-row">
                            <span class="info-label">Role:</span>
                            <span class="role-badge role-{{ user.role }}">
                                {{ user.role|title }}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            {% if user.is_admin() %}
                                <span class="status-badge status-admin">Admin</span>
                            {% elif user.is_approved %}
                                <span class="status-badge status-approved">Approved</span>
                            {% elif not user.is_active %}
                                <span class="status-badge status-suspended">Suspended</span>
                            {% else %}
                                <span class="status-badge status-pending">Pending</span>
                            {% endif %}
                        </div>
                        <div class="info-row">
                            <span class="info-label">Active:</span>
                            <span class="info-value">{{ 'Yes' if user.is_active else 'No' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Approved:</span>
                            <span class="info-value">{{ 'Yes' if user.is_approved else 'No' }}</span>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h4>Spiritual Practice</h4>
                        <div class="info-row">
                            <span class="info-label">Spiritual Name:</span>
                            <span class="info-value">{{ user.spiritual_name or 'Not provided' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Guru Name:</span>
                            <span class="info-value">{{ user.guru_name or 'Not provided' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Practice Level:</span>
                            <span class="info-value">{{ user.practice_level or 'Not specified' }}</span>
                        </div>
                    </div>
                    
                    <div class="info-section purpose-section">
                        <h4>Purpose for Sadhana</h4>
                        <div class="purpose-content">
                            <p class="purpose-text">{{ user.purpose }}</p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h4>Timestamps</h4>
                        <div class="info-row">
                            <span class="info-label">Created:</span>
                            <span class="info-value">{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                        </div>
                        {% if user.approved_at %}
                        <div class="info-row">
                            <span class="info-label">Approved:</span>
                            <span class="info-value">{{ user.approved_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                        </div>
                        {% endif %}
                        {% if user.approved_by %}
                        <div class="info-row">
                            <span class="info-label">Approved By:</span>
                            <span class="info-value">User ID: {{ user.approved_by }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h4>Quick Actions</h4>
                    <div class="action-buttons">
                        {% if not user.is_admin() %}
                            {% if user.is_approved and user.is_active %}
                                <button class="btn btn-warning suspend-user" 
                                        data-user-id="{{ user.id }}" title="Suspend User">
                                    ‚è∏Ô∏è Suspend User
                                </button>
                            {% elif not user.is_approved and user.is_active %}
                                <button class="btn btn-success approve-user" 
                                        data-user-id="{{ user.id }}" title="Approve User">
                                    ‚úÖ Approve User
                                </button>
                                <button class="btn btn-danger reject-user" 
                                        data-user-id="{{ user.id }}" title="Reject User">
                                    ‚ùå Reject User
                                </button>
                            {% elif not user.is_active %}
                                <button class="btn btn-success reactivate-user" 
                                        data-user-id="{{ user.id }}" title="Reactivate User">
                                    üîÑ Reactivate User
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Mandala Access Management -->
                <div class="mandala-access-section">
                    <h4>üïâÔ∏è Mandala Access Management</h4>
                    <form method="POST" action="{{ url_for('auth.update_mandala_access', user_id=user.id) }}" class="mandala-access-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mandala-access-grid">
                            <div class="mandala-access-item">
                                <label class="mandala-access-label">
                                    <input type="checkbox" name="mandala_1_access" checked disabled>
                                    <span class="mandala-icon">üïâÔ∏è</span>
                                    <span class="mandala-text">
                                        <strong>Mandala 1</strong>
                                        <small>Foundation (Always Available)</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="mandala-access-item">
                                <label class="mandala-access-label">
                                    <input type="checkbox" name="mandala_2_access" {% if user.mandala_2_access %}checked{% endif %}>
                                    <span class="mandala-icon">üåü</span>
                                    <span class="mandala-text">
                                        <strong>Mandala 2</strong>
                                        <small>Advancement (Admin Approval Required)</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="mandala-access-item">
                                <label class="mandala-access-label">
                                    <input type="checkbox" name="mandala_3_access" {% if user.mandala_3_access %}checked{% endif %}>
                                    <span class="mandala-icon">‚ú®</span>
                                    <span class="mandala-text">
                                        <strong>Mandala 3</strong>
                                        <small>Mastery (Admin Approval Required)</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mandala-access-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Mandala Access
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success/Error Messages -->
<div id="message-container" class="message-container" style="display: none;">
    <div class="message-content">
        <span id="message-text"></span>
        <button class="message-close" onclick="hideMessage()">√ó</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle quick action buttons
    document.querySelectorAll('.approve-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'approve', 'Approved via user detail page');
        });
    });
    
    document.querySelectorAll('.reject-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'reject', 'Rejected via user detail page');
        });
    });
    
    document.querySelectorAll('.suspend-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'suspend', 'Suspended via user detail page');
        });
    });
    
    document.querySelectorAll('.reactivate-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'approve', 'Reactivated via user detail page');
        });
    });
});

function executeUserAction(userId, action, notes) {
    fetch('{{ url_for("auth.approve_user") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'user_id': userId,
            'action': action,
            'notes': notes,
            'csrf_token': document.querySelector('input[name="csrf_token"]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Reload page after short delay to show updated status
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const messageText = document.getElementById('message-text');
    
    messageText.textContent = message;
    container.className = `message-container message-${type}`;
    container.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => hideMessage(), 5000);
}

function hideMessage() {
    document.getElementById('message-container').style.display = 'none';
}
</script>
{% endblock %}
