{% extends "base.html" %}

{% block content %}
<section class="admin-section user-detail-page">
    <div class="container">
        <div class="page-header">
            <a href="{{ url_for('auth.admin_users') }}" class="btn btn-secondary">‚Üê Back to Users</a>
            <h2 class="section-title">User Details</h2>
        </div>

        <div class="user-detail-grid">
            <!-- Left Column: User Info -->
            <div class="user-info-col">
                <div class="user-detail-card">
                    <div class="card-header">
                        <div class="user-avatar">
                            <img src="https://i.pravatar.cc/150?u={{ user.id }}" alt="User Avatar">
                        </div>
                        <div class="user-primary-info">
                            <h3 class="user-name">{{ user.full_name }}</h3>
                            <p class="user-username">@{{ user.username }}</p>
                            {% if user.spiritual_name %}
                                <p class="user-spiritual-name">({{ user.spiritual_name }})</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-content">
                        <h4>Basic Information</h4>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Email:</span> <span class="info-value">{{ user.email }}</span></div>
                            <div class="info-item"><span class="info-label">Phone:</span> <span class="info-value">{{ user.phone or 'N/A' }}</span></div>
                            <div class="info-item"><span class="info-label">Joined:</span> <span class="info-value">{{ user.created_at.strftime('%b %d, %Y') }}</span></div>
                        </div>
                        <hr>
                        <h4>Spiritual Practice</h4>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Guru:</span> <span class="info-value">{{ user.guru_name or 'N/A' }}</span></div>
                            <div class="info-item"><span class="info-label">Level:</span> <span class="info-value">{{ user.practice_level or 'N/A' }}</span></div>
                        </div>
                        <hr>
                        <h4>Purpose for Sadhana</h4>
                        <p class="purpose-text">{{ user.purpose }}</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Actions and Status -->
            <div class="user-actions-col">
                <div class="user-status-card">
                    <h4>Account Status</h4>
                    <div class="status-grid">
                        <div class="info-item"><span class="info-label">Role:</span> <span class="role-badge role-{{ user.role }}">{{ user.role|title }}</span></div>
                        <div class="info-item"><span class="info-label">Status:</span>
                            {% if user.is_admin() %}
                                <span class="status-badge status-admin">Admin</span>
                            {% elif user.is_approved %}
                                <span class="status-badge status-approved">Approved</span>
                            {% elif not user.is_active %}
                                <span class="status-badge status-suspended">Suspended</span>
                            {% else %}
                                <span class="status-badge status-pending">Pending</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="quick-actions">
                        {% if not user.is_admin() %}
                            {% if user.is_approved and user.is_active %}
                                <button class="btn btn-warning suspend-user" data-user-id="{{ user.id }}"><i class="fas fa-pause-circle"></i> Suspend User</button>
                            {% elif not user.is_approved and user.is_active %}
                                <button class="btn btn-success approve-user" data-user-id="{{ user.id }}"><i class="fas fa-check-circle"></i> Approve User</button>
                                <button class="btn btn-danger reject-user" data-user-id="{{ user.id }}"><i class="fas fa-times-circle"></i> Reject User</button>
                            {% elif not user.is_active %}
                                <button class="btn btn-success reactivate-user" data-user-id="{{ user.id }}"><i class="fas fa-play-circle"></i> Reactivate User</button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="progress-section">
                    <h4>üïâÔ∏è Spiritual Progress</h4>

                    <!-- Vertical Progress Bar -->
                    <div class="vertical-progress-container">
                        <div class="progress-track">
                            {% for stage_num in range(1, 7) %}
                                {% set stage_info = user.get_stage_info(stage_num) %}
                                {% set is_current = stage_num == user.get_current_stage() %}
                                {% set is_completed = stage_info.is_completed %}

                                <div class="progress-step {% if is_completed %}completed{% elif is_current %}current{% else %}locked{% endif %}">
                                    <div class="progress-node">
                                        <div class="node-circle {% if is_completed %}completed{% elif is_current %}current{% else %}locked{% endif %}">
                                            {% if stage_num == 1 %}üïâÔ∏è{% elif stage_num == 2 %}üåü{% elif stage_num == 3 %}‚ú®{% elif stage_num == 4 %}üìø{% elif stage_num == 5 %}üîÆ{% else %}üíé{% endif %}
                                        </div>
                                        {% if is_completed %}
                                            <div class="completion-check">‚úì</div>
                                        {% endif %}
                                    </div>
                                    <div class="progress-info">
                                        <div class="stage-name">{{ stage_info.stage_name }}</div>
                                        {% if stage_info.completion_date %}
                                            <div class="completion-date">Completed: {{ stage_info.completion_date.strftime('%b %d, %Y') }}</div>
                                        {% elif stage_info.start_date and is_current %}
                                            <div class="start-date">Started: {{ stage_info.start_date.strftime('%b %d, %Y') }}</div>
                                        {% elif is_current %}
                                            <div class="current-status">Current Stage</div>
                                        {% else %}
                                            <div class="locked-status">üîí Locked</div>
                                        {% endif %}
                                        {% if stage_info.duration_days > 0 %}
                                            <div class="duration">Duration: {{ stage_info.duration_days }} days</div>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if stage_num < 6 %}
                                    <div class="progress-connector {% if is_completed %}completed{% else %}locked{% endif %}"></div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Current Status -->
                    <div class="current-status-card">
                        <h5>Current Status</h5>
                        {% set next_stage = user.get_next_required_stage() %}
                        {% if next_stage %}
                            <p><strong>Next Required Stage:</strong> {{ user.get_stage_info(next_stage).stage_name }}</p>
                        {% else %}
                            <p><strong>All stages completed! üéâ</strong></p>
                        {% endif %}
                        <p><strong>Current Stage:</strong> {{ user.get_stage_info(user.get_current_stage()).stage_name }}</p>
                    </div>
                </div>

                <div class="stage-access-card">
                    <h4>üìã Stage Management</h4>
                    <form method="POST" action="{{ url_for('auth.update_stage_access', user_id=user.id) }}" class="stage-access-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="stage-access-grid">
                            <div class="stage-access-item granted">
                                <div class="stage-icon">üïâÔ∏è</div>
                                <div class="stage-info">
                                    <strong>Mandala 1</strong>
                                    <small>Auto-granted</small>
                                </div>
                                <div class="stage-status">‚úì</div>
                            </div>
                            <div class="stage-access-item {% if user.mandala_2_access %}granted{% else %}locked{% endif %}">
                                <div class="stage-icon">üåü</div>
                                <div class="stage-info">
                                    <strong>Mandala 2</strong>
                                    <small>{% if user.mandala_2_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="stage-status">
                                    <label class="switch">
                                        <input type="checkbox" name="mandala_2_access" {% if user.mandala_2_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="stage-access-item {% if user.mandala_3_access %}granted{% else %}locked{% endif %}">
                                <div class="stage-icon">‚ú®</div>
                                <div class="stage-info">
                                    <strong>Mandala 3</strong>
                                    <small>{% if user.mandala_3_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="stage-status">
                                    <label class="switch">
                                        <input type="checkbox" name="mandala_3_access" {% if user.mandala_3_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="stage-access-item {% if user.rudraksha_5_mukhi_access %}granted{% else %}locked{% endif %}">
                                <div class="stage-icon">üìø</div>
                                <div class="stage-info">
                                    <strong>Rudraksha 5 Mukhi</strong>
                                    <small>{% if user.rudraksha_5_mukhi_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="stage-status">
                                    <label class="switch">
                                        <input type="checkbox" name="rudraksha_5_mukhi_access" {% if user.rudraksha_5_mukhi_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="stage-access-item {% if user.rudraksha_11_mukhi_access %}granted{% else %}locked{% endif %}">
                                <div class="stage-icon">üîÆ</div>
                                <div class="stage-info">
                                    <strong>Rudraksha 11 Mukhi</strong>
                                    <small>{% if user.rudraksha_11_mukhi_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="stage-status">
                                    <label class="switch">
                                        <input type="checkbox" name="rudraksha_11_mukhi_access" {% if user.rudraksha_11_mukhi_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="stage-access-item {% if user.rudraksha_14_mukhi_access %}granted{% else %}locked{% endif %}">
                                <div class="stage-icon">üíé</div>
                                <div class="stage-info">
                                    <strong>Rudraksha 14 Mukhi</strong>
                                    <small>{% if user.rudraksha_14_mukhi_access %}Access Granted{% else %}Admin Approval Required{% endif %}</small>
                                </div>
                                <div class="stage-status">
                                    <label class="switch">
                                        <input type="checkbox" name="rudraksha_14_mukhi_access" {% if user.rudraksha_14_mukhi_access %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Access</button>
                    </form>

                    <!-- Stage Actions -->
                    <div class="stage-actions">
                        <h5>Stage Actions</h5>
                        <div class="action-buttons">
                            {% for stage_num in range(1, 7) %}
                                {% set stage_info = user.get_stage_info(stage_num) %}
                                {% if stage_info.has_access and not stage_info.is_completed %}
                                    <form method="POST" action="{{ url_for('auth.complete_user_stage', user_id=user.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="stage_number" value="{{ stage_num }}">
                                        <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Mark {{ stage_info.stage_name }} as completed?')">
                                            <i class="fas fa-check"></i> Complete {{ stage_info.stage_name }}
                                        </button>
                                    </form>
                                {% endif %}
                                {% if stage_info.is_completed %}
                                    <form method="POST" action="{{ url_for('auth.reset_user_stage', user_id=user.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="stage_number" value="{{ stage_num }}">
                                        <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Reset {{ stage_info.stage_name }} and all subsequent stages?')">
                                            <i class="fas fa-undo"></i> Reset {{ stage_info.stage_name }}
                                        </button>
                                    </form>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Pending Stage Access Requests -->
                    {% if pending_requests %}
                    <div class="pending-requests-card">
                        <h4>üìã Pending Access Requests</h4>
                        <div class="requests-list">
                            {% for request in pending_requests %}
                            <div class="request-item-detail" data-request-id="{{ request.id }}">
                                <div class="request-info">
                                    <div class="request-stage">{{ request.get_stage_name() }}</div>
                                    <div class="request-date">Requested {{ request.requested_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                                </div>
                                <div class="request-actions">
                                    <button class="btn btn-success btn-sm btn-approve-request" data-request-id="{{ request.id }}">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm btn-reject-request" data-request-id="{{ request.id }}">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success/Error Messages -->
<div id="message-container" class="message-container" style="display: none;">
    <div class="message-content">
        <span id="message-text"></span>
        <button class="message-close" onclick="hideMessage()">√ó</button>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Action</h3>
            <button class="modal-close" onclick="closeConfirmationModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p id="confirmation-message"></p>
        </div>
        <div class="modal-footer">
            <button id="confirm-action-btn" class="btn btn-danger">Confirm</button>
            <button class="btn btn-secondary" onclick="closeConfirmationModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle quick action buttons
    document.querySelectorAll('.approve-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'approve', 'Approved via user detail page');
        });
    });
    
    document.querySelectorAll('.reject-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            openConfirmationModal('Are you sure you want to reject this user?', function() {
                executeUserAction(userId, 'reject', 'Rejected via user detail page');
            });
        });
    });
    
    document.querySelectorAll('.suspend-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            openConfirmationModal('Are you sure you want to suspend this user?', function() {
                executeUserAction(userId, 'suspend', 'Suspended via user detail page');
            });
        });
    });
    
    document.querySelectorAll('.reactivate-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            executeUserAction(userId, 'approve', 'Reactivated via user detail page');
        });
    });
    
    // Handle stage access request approvals
    document.querySelectorAll('.btn-approve-request').forEach(btn => {
        btn.addEventListener('click', function() {
            const requestId = this.dataset.requestId;
            approveStageRequest(requestId, 'approve');
        });
    });
    
    // Handle stage access request rejections
    document.querySelectorAll('.btn-reject-request').forEach(btn => {
        btn.addEventListener('click', function() {
            const requestId = this.dataset.requestId;
            openConfirmationModal('Are you sure you want to reject this access request?', function() {
                approveStageRequest(requestId, 'reject');
            });
        });
    });
});

function approveStageRequest(requestId, action) {
    const csrfToken = '{{ csrf_token() }}';
    const btn = document.querySelector(`.btn-approve-request[data-request-id="${requestId}"], .btn-reject-request[data-request-id="${requestId}"]`);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    }
    
    fetch(`/auth/admin/approve_stage_request/${requestId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'action': action,
            'csrf_token': csrfToken
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Remove the request item from the list
            const requestItem = document.querySelector(`.request-item-detail[data-request-id="${requestId}"]`);
            if (requestItem) {
                requestItem.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    requestItem.remove();
                    // Reload page to update stage access
                    setTimeout(() => location.reload(), 500);
                }, 300);
            }
        } else {
            showMessage('Error: ' + data.message, 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = action === 'approve' ? '<i class="fas fa-check"></i> Approve' : '<i class="fas fa-times"></i> Reject';
            }
        }
    })
    .catch(error => {
        showMessage('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = action === 'approve' ? '<i class="fas fa-check"></i> Approve' : '<i class="fas fa-times"></i> Reject';
        }
    });
}

function executeUserAction(userId, action, notes) {
    fetch('{{ url_for("auth.approve_user") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'user_id': userId,
            'action': action,
            'notes': notes,
            'csrf_token': '{{ csrf_token() }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            // Reload page after short delay to show updated status
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('An error occurred. Please try again.', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const messageText = document.getElementById('message-text');
    
    messageText.textContent = message;
    container.className = `message-container message-${type}`;
    container.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => hideMessage(), 5000);
}

function hideMessage() {
    document.getElementById('message-container').style.display = 'none';
}

function openConfirmationModal(message, onConfirm) {
    const modal = document.getElementById('confirmation-modal');
    const messageElement = document.getElementById('confirmation-message');
    const confirmBtn = document.getElementById('confirm-action-btn');

    messageElement.textContent = message;
    modal.style.display = 'flex';

    confirmBtn.onclick = function() {
        onConfirm();
        closeConfirmationModal();
    };
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.style.display = 'none';
}
</script>
{% endblock %}
