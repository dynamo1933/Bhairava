{% extends "base.html" %}

{% block content %}
<div class="container admin-dashboard">
    <div class="dashboard-header">
        <div class="dashboard-title-section">
            <div class="dashboard-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="dashboard-title">
                <h1>User Messages</h1>
                <p>Respond to user queries regarding sadhana</p>
            </div>
        </div>
        <div class="dashboard-actions">
            <a href="{{ url_for('auth.admin_users') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="admin-chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-sidebar-header">
                Active Conversations
            </div>
            <div id="user-list" class="chat-user-list">
                <!-- User list will be loaded here -->
                <div style="padding: 1rem; color: #666; font-style: italic;">Loading users...</div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="admin-chat-main">
            <div id="chat-header" class="admin-chat-header">
                Select a user to start chatting
            </div>
            <div id="admin-chat-messages" class="admin-chat-messages">
                <!-- Messages will appear here -->
                <div class="chat-placeholder">
                    <p>Select a conversation from the left.</p>
                </div>
            </div>
            <div class="admin-chat-input-area" id="input-area" style="display: none;">
                <input type="text" id="admin-chat-input" class="admin-chat-input" placeholder="Type your reply...">
                <button id="admin-chat-send" class="admin-chat-send">Send</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userListContainer = document.getElementById('user-list');
        const chatHeader = document.getElementById('chat-header');
        const messagesContainer = document.getElementById('admin-chat-messages');
        const inputArea = document.getElementById('input-area');
        const inputField = document.getElementById('admin-chat-input');
        const sendButton = document.getElementById('admin-chat-send');

        let currentUserId = null;
        let pollInterval = null;
        const POLL_RATE = 10000;

        // Load users initially
        loadUsers();

        // Refresh users every 30s
        setInterval(loadUsers, 30000);

        function loadUsers() {
            fetch('/api/admin/chat/users')
                .then(res => res.json())
                .then(users => {
                    if (users.error) return;
                    renderUserList(users);
                })
                .catch(err => console.error('Error loading users:', err));
        }

        function renderUserList(users) {
            if (users.length === 0) {
                userListContainer.innerHTML = '<div style="padding: 1rem; color: #666;">No active conversations</div>';
                return;
            }

            userListContainer.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = `chat-user-item ${currentUserId === user.id ? 'active' : ''}`;
                div.onclick = () => selectUser(user);

                div.innerHTML = `
                <div style="width: 40px; height: 40px; background: #ddd; border-radius: 50%; overflow: hidden;">
                    ${user.profile_picture ?
                        `<img src="${user.profile_picture}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">' + user.full_name.charAt(0) + '</div>'}
                </div>
                <div>
                    <div style="font-weight: 600; font-size: 0.9rem;">${user.full_name}</div>
                    <div style="font-size: 0.75rem; color: #888;">@${user.username}</div>
                </div>
                ${user.unread_count > 0 ? `<div class="unread-badge">${user.unread_count}</div>` : ''}
            `;

                userListContainer.appendChild(div);
            });
        }

        function selectUser(user) {
            currentUserId = user.id;
            chatHeader.innerHTML = `Chatting with ${user.full_name}`;
            inputArea.style.display = 'flex';

            // Refresh UI to show active state
            const items = document.querySelectorAll('.chat-user-item');
            items.forEach(item => item.classList.remove('active'));
            // (Re-rendering would be cleaner but this works for now)
            loadUsers(); // Refresh to update active class in full render or just trust user selected

            loadMessages(user.id);
            startPolling();

            // Mark as read
            markAsRead(user.id);
        }

        function loadMessages(userId) {
            if (!userId) return;

            fetch(`/api/admin/chat/${userId}`)
                .then(res => res.json())
                .then(messages => {
                    renderMessages(messages);
                });
        }

        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div class="chat-placeholder"><p>No messages yet.</p></div>';
                return;
            }

            messages.forEach(msg => {
                const div = document.createElement('div');
                // Admin checks: is_from_admin means "me" (Admin)
                div.className = `chat-message ${msg.is_from_admin ? 'user' : 'admin'}`;
                // If from admin (me), style as 'user' (right side)
                // If from user (them), style as 'admin' (left side)
                // Reusing the existing classes: .user is right/red, .admin is left/white

                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                div.innerHTML = `
                <div class="message-content">${escapeHtml(msg.message)}</div>
                <div class="message-time">${time}</div>
            `;
                messagesContainer.appendChild(div);
            });

            scrollToBottom();
        }

        function markAsRead(userId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            fetch('/api/chat/mark-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ user_id: userId })
            });
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => {
                if (currentUserId) loadMessages(currentUserId);
            }, POLL_RATE);
        }

        sendButton.onclick = sendMessage;
        inputField.onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };

        function sendMessage() {
            if (!currentUserId) return;
            const text = inputField.value.trim();
            if (!text) return;

            // Optimistic append
            renderMessages([...getCurrentMessages(), {
                message: text,
                is_from_admin: true,
                timestamp: new Date().toISOString()
            }]); // This is tricky without state, better to just loadMessages after send

            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

            fetch('/api/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: text,
                    recipient_id: currentUserId
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        inputField.value = '';
                        loadMessages(currentUserId);
                    }
                });
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper to get current messages if needed
        function getCurrentMessages() {
            // Implementation omitted, better to just reload
            return [];
        }
    });
</script>

<style>
    /* Override/Specific styles for admin chat that differ from widget */
    .admin-chat-messages .chat-message {
        max-width: 60%;
    }
</style>
{% endblock %}